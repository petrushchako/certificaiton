# Demo<br>Creating CloudWatch Metric Filter

![](../img/demo/3.3.CloudWatch-MetricFilters.png)

<br>

### Lesson Objectives
1. **Create a basic Lambda Function**<br>A new log group is automatically created, enabling it to send logs to CloudWatch.
2. **Test**<br>Test that our function is working, which will generatesome log events.
3. **Explore the options**<br>Explore how to monitor for specific terms or value appearing in our logs.
4. **Create a Metric Filter**<br>Create a metric filter that will cause CloudWatch to alert if any errors appear in the log.


<br><br><br>

<h2>Solution</h2>

## Create a basic Lambda Function
- In Console navigate to `Lambda` and select `Create function`
- Provide the following details in **Create function** page
  - Function type:
    - [x] Author from scratch
    - [ ] Use a blueprint
    - [ ] Container image
  - Function name: `my-lambda-function`
  - Runtime: `Node.js 18.x`
  - Architecture: 
    - [x] `x86_64`
    - [ ] `arm64`
  - All other settings should remain default
  - `Create function`
- On the next configuration screen, navigate to `Code source` and alter content of the `index.mjs` file. Add following code:
  
    ```js
    export const handler = async(event) => {
        // TODO implement
        const response = {
            statusCode: 200,
            body: JSON.stringify('Hello from Lambda');
        };
        return response;
    }
    ```
- Select `Deploy` to save changes

<br>

## Test
- Once the code changes have been saved, you can test the function. Select `Test` drop-down and select `Configure test event`.
- In `Configure test event` provide following details:
  - Test event action: `Create new event`
  - Event name: `test1`
  - Event sharing settings: `Private`
  - Template - optional: `hello-world`
  - Event JSON: 
    ```json
    {
        "key1":"value1",
        "key2":"value2",
        "key3":"value3"
    }
    ```
  - `Save`
- Once the function code was added and test created, select `Test` button few times to generate activity in logs.

<br>

## Explore the options
- In `CloudWatch` navigate to `Logs` -> `Log groups`<br>This will show logs that have been automatically created when we created our function. And the `/aws/lambda/my-lambda-function` group is created to collect logs from our function.
- Select the `/aws/lambda/my-lambda-function` log group and scroll down to the `Log streams`
- Inside log stream you will be able to see log events generated by Lambda function. 
  - We have the time when the event started `START` and ended `END`
  - In the `REPORT`, it's telling us the duration that the Lambda function ran for, how many milliseconds we've been billed for and the ammount of memory alloated to the function.

<br>

## Create a Metric Filter
- Navigate to `CloudWatch` -> `Logs` -> `Log groups`
- Select `/aws/lambda/my-lambda-function` log group and in `Actions` select `Create metric filter`
- Step 1<br>Define pattern:
    > You can use metric filters to monitor events in a log group as they are sent to CloudWatch Logs. You can monitor and count specific terms or extract values from log events and associate the results with a metric.
  - Filter pattern: `error`
  - In `Test pattern` select log data generated by Lambda function.
  - Press `Test patern` to verify functionality of configured filter pattern (i.e. `error`)
    > Note that pattern you are serching for might not have occured in the logs you are using as sample data
  - `Next`
- Step 2<br>Assign metric
  - Filter name: `my-lambda-filter` <br>(Namespaces let you group similar metrics)
  - Metric namespace: `lambda-errors-namespace` <br>(Metric name identifies this metric, and must be unique within the namespace)
  - Metric name: `lambda-log-errors` <br>(Metric value is the value published to the metric name when a Filter Pattern match occurs)
  - Metric value: `1` <br>(Metric value is the vlaue published to the metric name when a Filter Pattern match occurs)
  - Default value: `0`
- Step 3<br>Review and create
  - Select `Create metric filter` to create filter


<br>
